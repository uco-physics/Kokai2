<!DOCTYPE html>
<html lang='ja'>
<head>
  <meta charset='UTF-8'>
  <meta name='viewport' content='width=device-width, initial-scale=1.0'>
  <title>鍵ペア生成ツール (MVP)</title>
  <!-- Tailwind CSS CDN -->
  <script src='https://cdn.tailwindcss.com'></script>
  <!-- React, ReactDOM CDN (開発用) -->
  <script src='https://unpkg.com/react@18/umd/react.development.js' crossorigin></script>
  <script src='https://unpkg.com/react-dom@18/umd/react-dom.development.js' crossorigin></script>
  <!-- 暗号化ライブラリ -->
  <script src='https://unpkg.com/node-forge/dist/forge.min.js'></script>
  <script src='https://unpkg.com/openpgp@5.5.0/dist/openpgp.min.js'></script>
  <!-- Babel for JSX -->
  <script src='https://unpkg.com/@babel/standalone/babel.min.js'></script>
</head>
<body class='bg-gray-50'>
  <div id='root'></div>

  <!-- アプリ本体 -->
  <script type='text/babel'>
    // ArrayBufferをBase64に変換するユーティリティ
    function arrayBufferToBase64(buffer) {
      const bytes = new Uint8Array(buffer);
      let binary = '';
      for (let i = 0; i < bytes.byteLength; i++) {
        binary += String.fromCharCode(bytes[i]);
      }
      return window.btoa(binary);
    }

    // CryptoKeyをPEM形式に変換
    async function exportCryptoKeyToPem(key) {
      const exported = await window.crypto.subtle.exportKey(
        key.type === 'public' ? 'spki' : 'pkcs8',
        key
      );
      const b64 = arrayBufferToBase64(exported);
      const type = key.type === 'public' ? 'PUBLIC KEY' : 'PRIVATE KEY';
      const formatted = b64.match(/.{1,64}/g).join('\n');
      return `-----BEGIN ${type}-----
${formatted}
-----END ${type}-----`;
    }

    // RSA鍵ペアを生成
    async function generateRSAKey(modulusLength) {
      return await window.crypto.subtle.generateKey(
        {
          name: 'RSA-OAEP',
          modulusLength: modulusLength,
          publicExponent: new Uint8Array([1, 0, 1]),
          hash: 'SHA-256'
        },
        true,
        ['encrypt', 'decrypt']
      );
    }

    function App() {
      const [algorithm, setAlgorithm] = React.useState('RSA');
      const [keySize, setKeySize] = React.useState('2048');
      const [format, setFormat] = React.useState('PEM');
      const [publicKeyPem, setPublicKeyPem] = React.useState('');
      const [privateKeyPem, setPrivateKeyPem] = React.useState('');

      const handleGenerateClick = async () => {
        setPublicKeyPem('');
        setPrivateKeyPem('');
        if (algorithm === 'RSA') {
          const keyPair = await generateRSAKey(parseInt(keySize, 10));
          const pubPem = await exportCryptoKeyToPem(keyPair.publicKey);
          const privPem = await exportCryptoKeyToPem(keyPair.privateKey);
          setPublicKeyPem(pubPem);
          setPrivateKeyPem(privPem);
        } else {
          alert(algorithm + 'はMVPでは未対応です');
        }
      };

      // 鍵サイズ/曲線の選択肢
      const keySizeOptions = algorithm === 'RSA'
        ? ['2048', '3072', '4096']
        : algorithm === 'ECDSA'
        ? ['P-256', 'P-384']
        : ['Ed25519', 'Ed448'];

      return (
        <div className='container mx-auto p-4'>
          <h1 className='text-xl font-bold mb-4'>鍵ペア生成ツール (MVP)</h1>

          {/* ステップ1: 暗号方式選択 */}
          <div className='mb-4'>
            <label className='block mb-1'>方式選択</label>
            <select
              value={algorithm}
              onChange={e => setAlgorithm(e.target.value)}
              className='border p-2'
            >
              <option value='RSA'>RSA</option>
              <option value='ECDSA' disabled>ECDSA</option>
              <option value='EdDSA' disabled>EdDSA</option>
            </select>
          </div>

          {/* ステップ2: 鍵サイズ/曲線選択 */}
          <div className='mb-4'>
            <label className='block mb-1'>鍵サイズ/曲線</label>
            <select
              value={keySize}
              onChange={e => setKeySize(e.target.value)}
              className='border p-2'
            >
              {keySizeOptions.map(size => (
                <option key={size} value={size}>{size}</option>
              ))}
            </select>
          </div>

          {/* ステップ3: 出力形式選択 */}
          <div className='mb-4'>
            <label className='block mb-1'>出力形式</label>
            <select
              value={format}
              onChange={e => setFormat(e.target.value)}
              className='border p-2'
            >
              <option value='PEM'>PEM</option>
              <option value='JWK' disabled>JWK</option>
              <option value='SSH' disabled>SSH</option>
              <option value='OpenPGP' disabled>OpenPGP</option>
            </select>
          </div>

          {/* 生成ボタン */}
          <button
            onClick={handleGenerateClick}
            className='px-4 py-2 bg-blue-600 text-white rounded'
          >生成</button>

          {/* 結果表示 */}
          {publicKeyPem && (
            <div className='mt-6'>
              <h2 className='font-semibold mb-1'>公開鍵</h2>
              <textarea
                readOnly
                value={publicKeyPem}
                className='w-full h-40 border p-2 mb-4'
              />
              <h2 className='font-semibold mb-1'>秘密鍵</h2>
              <textarea
                readOnly
                value={privateKeyPem}
                className='w-full h-40 border p-2'
              />
            </div>
          )}
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
